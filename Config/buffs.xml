<?xml version="1.0" encoding="utf-8" ?>
<!--
  Demonata Gaming Metadata Format ©2025
  SPDX-License-Identifier: LicenseRef-DemonataGaming-Metadata-1.0
  See LICENSE.md for terms.
-->
<!--
  ==================================================
  Buffs Modification - Debuff Persistence, Hazard Effect Removal, and Respawn Health Override
  @version     1.2.0
  @date        2025-12-17
  @author      Demonata Gaming

  @group       BuffSystemReworks
  @description
    Adjusts player debuff persistence rules to retain negative statuses after death,
    removes intrusive screen tint effects tied to biome-specific hazard buffs,
    and overrides vanilla respawn behavior to prevent automatic full-health restoration.
    Reintegrates the old Well Insulated perk buffs back into the game.

  @notes
    - Negative buffs like infection and broken limbs persist through death.
    - Infection-related buffs now tagged and grouped for death retention logic.
    - Visual screen effects from biome hazards are disabled for all major biomes.
    - Disables vanilla `buffDeathFoodDrinkAdjust` health restore to allow custom respawn health values.
    - No core buffs overwritten—XPath-only, fully compatible with other mods.
  ==================================================
-->
<configs>
  <!--
  ===============================
  SECTION: PLAYER BUFF STATUS CHANGES (GAMEEVENTS DEPENDENT)
  ===============================
  @group      PlayerBuffStatusChanges
  @desc       Retains injuries and infections after death, disables respawn health restore,
              and requires gameevents overrides to function correctly.
  @notes      Some edits in this section depend on corresponding changes in gameevents.xml.
  @xref       gameevents.xml → SECTION: PLAYER RESPAWN CHANGES
  -->
  <!-- Disable vanilla "set Health to max" on respawn -->
  <remove xpath="/buffs/buff[@name='buffDeathFoodDrinkAdjust']/effect_group/triggered_effect[@trigger='onSelfBuffUpdate' and @action='ModifyStats' and @stat='Health']"/>
  <!-- Prevents the game's ability to remove negative effects after the players dies. -->
  <remove xpath="/buffs/buff[@name='buffNearDeathRegen']/effect_group/triggered_effect[@trigger='onSelfBuffStart' and @action='RemoveAllNegativeBuffs']" />
  <!-- Injuries Remain After Death -->
  <insertAfter xpath="/buffs/buff[@name='buffDysentery01GetBetterDiarrhea']/display_value[@value='.dysenteryDisplayPerc']">
    <tags value="deathpenalty_injured" />
  </insertAfter>
  <insertAfter xpath="/buffs/buff[@name='buffLegSprained']/display_value_format[@value='time']">
    <tags value="deathpenalty_injured" />
  </insertAfter>
  <insertAfter xpath="/buffs/buff[@name='buffLegBroken']/display_value_format[@value='time']">
    <tags value="deathpenalty_injured" />
  </insertAfter>
  <insertAfter xpath="/buffs/buff[@name='buffArmSprained']/display_value_format[@value='time']">
    <tags value="deathpenalty_injured" />
  </insertAfter>
  <insertAfter xpath="/buffs/buff[@name='buffArmBroken']/display_value_format[@value='time']">
    <tags value="deathpenalty_injured" />
  </insertAfter>
  <insertAfter xpath="/buffs/buff[@name='buffInfectionAddCure']/duration[@value='.1']">
    <tags value="deathpenalty_injured" />
  </insertAfter>
  <!-- Forces infection to remain on player after respawn. -->
  <append xpath="/buffs/buff[@name='buffInfection04']">
    <effect_group>
      <triggered_effect trigger="onSelfDied" action="RemoveBuff" buff="buffInfection01Main" />
      <triggered_effect trigger="onSelfDied" action="RemoveBuff" buff="buffInfectionMain" />
      <triggered_effect trigger="onSelfDied" action="RemoveBuff" buff="buffInfectionCatch" />
      <triggered_effect trigger="onSelfDied" action="RemoveBuff" buff="buffInfection04" />
    </effect_group>
  </append>
  <set xpath="/buffs/buff[@name='buffInfection04']/effect_group/triggered_effect[@trigger='onSelfDied' and @action='ModifyCVar' and @cvar='infectionCounter' and @operation='set']/@value">0</set>
  <!--
  ===============================
  SECTION: WELL INSULATED BUFF REINTEGRATED
  ===============================
  @group      PlayerBuffStatusChanges
  @desc         Ties the Well Insulated perk to the the elemental buffs.
  @notes       These changes rely on changes in the progression system.
  @xref          progression.xml → SECTION: WELL INSULATED PERK REINTEGRATED
  -->
  <!-- HOT BUFF -->
	<append xpath="/buffs/buff[@name='buffElementHot']">
		<effect_group>
			<!-- Level 1: -45% Water Loss -->
			<passive_effect name="WaterLossPerStaminaPointGained" operation="perc_add" value="-0.45">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="Equals" value="1"/>
			</passive_effect>
			<!-- Level 2: -90% Water Loss -->
			<passive_effect name="WaterLossPerStaminaPointGained" operation="perc_add" value="-0.9">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="GTE" value="2"/>
			</passive_effect>
		</effect_group>
	</append>
  <!-- SWELTERING BUFF -->
	<append xpath="/buffs/buff[@name='buffElementSweltering']">
		<effect_group>
			<!-- Level 1: -90% Water Loss -->
			<passive_effect name="WaterLossPerStaminaPointGained" operation="perc_add" value="-0.9">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="Equals" value="1"/>
			</passive_effect>
			<!-- Level 2: -180% Water Loss -->
			<passive_effect name="WaterLossPerStaminaPointGained" operation="perc_add" value="-1.8">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="GTE" value="2"/>
			</passive_effect>
		</effect_group>
	</append>
  <!-- COLD BUFF (Consolidated) -->
	<append xpath="/buffs/buff[@name='buffElementCold']">
		<effect_group>
			<!-- Food Change OT -->
			<passive_effect name="FoodChangeOT" operation="perc_add" value="-0.45">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="Equals" value="1"/>
			</passive_effect>
			<passive_effect name="FoodChangeOT" operation="perc_add" value="-0.9">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="GTE" value="2"/>
			</passive_effect>
  		<!-- Food Loss Per Stamina -->
			<passive_effect name="FoodLossPerStaminaPointGained" operation="perc_add" value="-0.15">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="Equals" value="1"/>
			</passive_effect>
			<passive_effect name="FoodLossPerStaminaPointGained" operation="perc_add" value="-0.3">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="GTE" value="2"/>
			</passive_effect>
		</effect_group>
	</append>
  <!-- FREEZING BUFF (Consolidated) -->
	<append xpath="/buffs/buff[@name='buffElementFreezing']">
		<effect_group>
			<!-- Food Change OT -->
			<passive_effect name="FoodChangeOT" operation="perc_add" value="-0.09">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="Equals" value="1"/>
			</passive_effect>
			<passive_effect name="FoodChangeOT" operation="perc_add" value="-0.18">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="GTE" value="2"/>
			</passive_effect>
      <!-- Food Loss Per Stamina -->
			<passive_effect name="FoodLossPerStaminaPointGained" operation="perc_add" value="-0.3">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="Equals" value="1"/>
			</passive_effect>
			<passive_effect name="FoodLossPerStaminaPointGained" operation="perc_add" value="-0.6">
				<requirement name="ProgressionLevel" progression_name="perkWellInsulated" operation="GTE" value="2"/>
			</passive_effect>
		</effect_group>
	</append>
</configs>
